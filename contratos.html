<!DOCTYPE html>

<html>

<head>
    <title>Relatorio de Contratos</title>
    <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico"/>

    <link rel="stylesheet" href="assets/plugins/jquery.dataTables.min.css">
    <link rel="stylesheet" href="assets/plugins/buttons.dataTables.min.css">
    <link rel="stylesheet" href="assets/plugins/bootstrap.min.css">

    <script type="text/javascript" charset="utf8" src="assets/plugins/jquery-1.12.4.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.2.4/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.2.4/js/buttons.html5.min.js"></script>
    <script type="text/javascript" charset="utf8" src="assets/plugins/jszip.min.js"></script>
    <script type="text/javascript" charset="utf8" src="assets/plugins/pdfmake.min.js"></script>
    <script type="text/javascript" charset="utf8" src="assets/plugins/vfs_fonts.js"></script>

    <script type="text/javascript" charset="utf8" src="assets/plugins/pdfmake.min.js"></script>
    <script type="text/javascript" charset="utf8" src="assets/plugins/vfs_fonts.js"></script>
    <link href="assets/plugins/jquery-scrollbar/jquery.scrollbar.css" rel="stylesheet" type="text/css" media="screen"/>
    <link href="pages/css/pages-icons.css" rel="stylesheet" type="text/css">
    <link class="main-stylesheet" href="pages/css/pages.css" rel="stylesheet" type="text/css"/>
<style>


#contratos {
  background-position: 10px 10px;
  background-size: 24px;
  background-repeat: no-repeat;
  font-size: 13px;
  border: 1px solid #ddd;
  margin-bottom: 12px;
}
    

.blue{
  color:#4d79ff;
}
.red{
  color:#ff4d4d;
}
    
.hide_column{
    display : none;
}
   

</style>
</head>

<body class="fixed-header  dashboard">

    <nav class="page-sidebar" data-pages="sidebar">
        <div class="sidebar-menu">
            <ul class="menu-items">
                <li class="m-t-30 open">
                    <a href="contratos.html" class="detailed">
                    <span class="title">Contratos</span>
                    <span class="details"></span>
                    </a>
                    <span class="icon-thumbnail bg-success"><i class="pg-layouts"></i></span>
                </li>
                <li class="">
                    <a href="processos.html" class="detailed">
                    <span class="title">Processos</span>
                    <span class="details"></span>
                    </a>
                    <span class="icon-thumbnail "><i class="pg-layouts"></i></span>
                </li>
            </ul>
            <div class="clearfix"></div>
        </div>
    </nav>


   <div class="page-container">
        <div class="header ">
            <img src="assets/img/header-fpf.jpg">
        </div>

        <div class="page-content-wrapper">
            <div class="content sm-gutter">
                 <div class="container-fluid padding-25 sm-padding-10">
                    <div class="row">      
                        <div class="col-md-12">
                            <div class="row">

                                <table id="contratos" class="display" cellspacing="0" width="100%">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Noderef</th>
                                            <th>Contratada</th>
                                            <th>Objeto</th>
                                            <th>Razão Social</th>
                                            <th>Fantasia</th>
                                            <th>CNPJ</th>
                                            <th>Data Assinatura</th>
                                            <th>Data Vencimento</th>
                                            <th>Proposta</th>
                                            <th>Contrato</th>
                                            <th>Valor</th>
                                            <th>Confidencial?</th>
                                            <th>Automatico?</th>
                                            <th>Tipo</th>
                                        </tr>
                                    </thead>
                                    <tfoot>
                                        <tr>
                                            <th>ID</th>
                                            <th>Noderef</th>
                                            <th>Contratada</th>
                                            <th>Objeto</th>
                                            <th>Razão Social</th>
                                            <th>Fantasia</th>
                                            <th>CNPJ</th>
                                            <th>Data Assinatura</th>
                                            <th>Data Vencimento</th>
                                            <th>Proposta</th>
                                            <th>Contrato</th>
                                            <th>Valor</th>
                                            <th>Confidencial</th>
                                            <th>Automatico</th>
                                            <th>Tipo</th>
                                        </tr>
                                    </tfoot>
                                    <tbody>
                                        <tr>
                                            <td>ID</td>
                                            <td>Noderef</td>
                                            <td>Contratada</td>
                                            <td>Objeto</td>
                                            <td>Razão Social</td>
                                            <td>Fantasia</td>
                                            <td>CNPJ</td>
                                            <td>Assinatura</td>
                                            <td>Vencimento</td>
                                            <td>Proposta</td>
                                            <td>Contrato</td>
                                            <td>Valor</td>
                                            <td>Confidencial</td>
                                            <td>Renova. auto</td>
                                            <td>Tipo</td>
                                        </tr>
                                    </tbody>
                                </table>

                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/plugins/modernizr.custom.js" type="text/javascript"></script>
    <script src="assets/plugins/jquery-scrollbar/jquery.scrollbar.min.js"></script>
    <script src="pages/js/pages.min.js"></script>


<script>

    $(document).ready(function () {

        $('#contratos').focus();

        $('#contratos').DataTable({

            dom: 'Bfrtip',

            fixedHeader: true,
            "paging": true,
            "ordering": true,
            "info": true,
            "searching": true,
            "ajax": 'http://fpf.ebravo.com.br/share/proxy/alfresco/fpfcontratos',
            //"ajax": 'contratos.txt',
            "order": [[7, "desc"]],
            "autoWidth": false,
            "fixedHeader": {
                "header": false,
                "footer": false
            },

            columnDefs: [
                    { "targets": [7, 8], "type": 'date-uk' },
                    //{ "visible": false, "targets": [0, 1] },
                    { className: "hide_column", "targets": [0, 1, 3, 4, 5, 6, 9, 10, 14] },
                    { "render": function (data, type, row) { return getURL(row[1], row[2]); }, "targets": 2 },
                    //{ "render": function (data, type, row) { return getCheck(row[10]); }, "targets": 10 },
                    //{ "render": function (data, type, row) { return getCheck(row[11]); }, "targets": 11 },
                    { className: "dt-left", "targets": [2] },
                    { className: "dt-center", "targets": [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14] }
                    //{ "width": "15%", "targets": [2] },
                    //{ "width": "10px", "targets": [7, 8, 11, 12, 13] }
                ],

            "language": {
                "sEmptyTable": "Nenhum registro encontrado",
                "sInfo": "Mostrando de _START_ ate _END_ de _TOTAL_ registros",
                "sInfoEmpty": "Mostrando 0 ate 0 de 0 registros",
                "sInfoFiltered": "(Filtrados de _MAX_ registros)",
                "sInfoPostFix": "",
                "sInfoThousands": ".",
                "sLengthMenu": "_MENU_ resultados por pagina",
                "sLoadingRecords": "Carregando...",
                "sProcessing": "Processando...",
                "sZeroRecords": "Nenhum registro encontrado!!!",
                "sSearch": "Pesquisar contratos:",
                "oPaginate": {
                    "sNext": "Proximo",
                    "sPrevious": "Anterior",
                    "sFirst": "Primeiro",
                    "sLast": "Ultimo"
                },
                "oAria": {
                    "sSortAscending": ": Ordenar colunas de forma ascendente",
                    "sSortDescending": ": Ordenar colunas de forma descendente"
                }

            },

            buttons: [
                    'excel', {
                        text: 'PDF',
                        orientation: 'landscape',
                        action: function (e, dt, node, config) {
                            doPDF();
                        }
                    }
                ]

        });

        // Setup - add a text input to each footer cell
        $('#contratos tfoot th').each(function () {
            var title = $(this).text();
            $(this).html('<input type="text" placeholder="' + title + '" />');
        });

        // DataTable
        var table = $('#contratos').DataTable();

        // Apply the search
        table.columns().every(function () {
            var that = this;

            $('input', this.footer()).on('keyup change', function () {
                if (that.search() !== this.value) {
                    that
                            .search(this.value)
                            .draw();
                }
            });
        });

    });


    jQuery.extend(jQuery.fn.dataTableExt.oSort, {
        "date-uk-pre": function (a) {
            if (a == null || a == "") {
                return 0;
            }
            var ukDatea = a.split('/');
            return (ukDatea[2] + ukDatea[1] + ukDatea[0]) * 1;
        },

        "date-uk-asc": function (a, b) {
            return ((a < b) ? -1 : ((a > b) ? 1 : 0));
        },

        "date-uk-desc": function (a, b) {
            return ((a < b) ? 1 : ((a > b) ? -1 : 0));
        }
    });


    function getCheck(ss) {

        if ("Sim" == ss) {
            return "<span class='glyphicon glyphicon-ok blue'></span>";
        }
        else {
            return "<span class='glyphicon glyphicon-remove red'></span>";
        }

    }

    function getURL(noderef, nome) {

        return "<a href=\"http://fpf.ebravo.com.br/share/page/site/jurdico/folder-details?nodeRef="+noderef+"\" target=\"_blank\">"+nome+"</a>";

    }

    function doPDF() {

        // lista de contratos para export
        var contratos = new Array();

        // lista de contratos da tela com filtro
        var rows = $("#contratos").dataTable().$('tr', { "filter": "applied" });

        // tabela do relatorio
        var body = [];

        var trow = 0;

        for (var i = 0; i < rows.length; i++) {

            var varURL = 'http://fpf.ebravo.com.br/share/page/site/jurdico/folder-details?nodeRef='+$(rows[i]).find("td:eq(1)").text();
            var varNomePasta = $(rows[i]).find("td:eq(2)").text();
            var varObjeto = $(rows[i]).find("td:eq(3)").text();
            var varRazaoSocial = $(rows[i]).find("td:eq(4)").text();
            var varNomeFantasia = $(rows[i]).find("td:eq(5)").text();
            var varCNPJ = $(rows[i]).find("td:eq(6)").text();
            var varDataAssinatura = $(rows[i]).find("td:eq(7)").text();
            var varDataVencimento = $(rows[i]).find("td:eq(8)").text();
            var varNumProposta = $(rows[i]).find("td:eq(9)").text();
            var varNumContrato = $(rows[i]).find("td:eq(10)").text();
            var varValorContrato = $(rows[i]).find("td:eq(11)").text();
            var varIsConfidencial = $(rows[i]).find("td:eq(12)").text();
            var varIsAutomatico = $(rows[i]).find("td:eq(13)").text();
            var varTipoContrato = $(rows[i]).find("td:eq(14)").text();

            var varPageBreak = 'after';
            
            if(trow == (rows.length - 1)) {
                 varPageBreak = '';
            }

            body[trow] = {
                pageBreak: varPageBreak,
		        margin: [20,20],
                style: 'tableExample',
                color: '#444',
                table: {
                    widths: [170, 170, 170, 190],
                    headerRows: 2,
                    body: [
					    [{text: varNomePasta, style: 'tableHeader', colSpan: 4, alignment: 'left'}, {}, {}, {}],
					    [
					        {text: 'CNPJ', style: 'tableHeader', alignment: 'center'}, 
					        {text: 'Assinatura', style: 'tableHeader', alignment: 'center'}, 
					        {text: 'Vencimento', style: 'tableHeader', alignment: 'center'},
					        {text: 'Valor', style: 'tableHeader', alignment: 'center'}
					    ],
					    [
					        {text: varCNPJ, alignment: 'center'}, 
					        {text: varDataAssinatura, alignment: 'center'}, 
					        {text: varDataVencimento, alignment: 'center'},
                            {text: varValorContrato, alignment: 'center'}
					    ],
					    [
					        {text: 'Proposta', style: 'tableHeader', alignment: 'center'}, 
					        {text: 'Contrato', style: 'tableHeader', alignment: 'center'}, 
					        {text: 'Confidencial ?', style: 'tableHeader', alignment: 'center'},
					        {text: 'Renovacao auto ?', style: 'tableHeader', alignment: 'center'}
					    ],
					    [
					        {text: varNumProposta, alignment: 'center'}, 
					        {text: varNumContrato, alignment: 'center'}, 
					        {text: varIsConfidencial, alignment: 'center'},
                            {text: varIsAutomatico, alignment: 'center'}
					    ],
                        [
                            { text: 'Razao Social', style: 'tableHeader', alignment: 'center' },
                            { text: varRazaoSocial, alignment: 'left', colSpan: 3 },
                            {},
                            {}
                        ],
                        [
                            { text: 'Nome Fantasia', style: 'tableHeader', alignment: 'center' },
                            { text: varNomeFantasia, alignment: 'left', colSpan: 3 },
                            {},
                            {}
                        ],
                        [
                            { text: 'Tipo de Contrato', style: 'tableHeader', alignment: 'center' },
                            { text: varTipoContrato, alignment: 'left', colSpan: 3 },
                            {},
                            {}
                        ],
                        [
                            { text: 'Objeto', style: 'tableHeader', alignment: 'center' },
                            { text: varObjeto, alignment: 'left', colSpan: 3 },
                            {},
                            {}
                        ],
                        [
                            { text: 'Clique aqui para acessar a pasta do contrato no GED', italics: true, link:varURL, alignment: 'center', colSpan: 4 },
                            {},
                            {},
                            {}
                        ]
				    ]
                }
            };

            trow += 1;

        }

        // https://github.com/bpampuch/pdfmake/issues/224
        //http://stackoverflow.com/questions/26658535/building-table-dynamically-with-pdfmake
        //https://github.com/bpampuch/pdfmake/issues/24
        //https://github.com/bpampuch/pdfmake/blob/master/examples/tables.js


        var docDefinition = {
            pageOrientation: 'landscape',
            pageSize: 'A4',
            header: {
                    margin: [10,18],
                    style: 'header',
                    columns: [
                        {
                            text: 'Relatorio de Contratos',
                            alignment: 'center'
                        }
                    ]
            },
    
            footer: function(page, pages) { 
                return { 
                    columns: [ 
                        {text: 'GED eBravo', alignment: 'left'},
                        {text: 'Federacao Paulista de Futebol', alignment: 'center'},
                        { 
                            alignment: 'right',
                            text: [
                                'Pag. ',
                                { text: page.toString(), italics: false },
                                ' de ',
                                { text: pages.toString(), italics: false }
                            ]
                        }
                    ],
                    margin: [40, 0]
                };
            },
            content: [
                body
            ],
            styles: {
                header: {
                    fontSize: 18,
                    bold: true,
                    margin: [0, 0, 0, 10]
                },
                subheader: {
                    fontSize: 16,
                    bold: true,
                    margin: [0, 10, 0, 5]
                },
                tableExample: {
                    margin: [0, 5, 0, 15]
                },
                tableHeader: {
                    bold: true,
                    fontSize: 13,
                    color: 'black'
                }
            },
            defaultStyle: {
                // alignment: 'justify'
            }

        };

        // open the PDF in a new window
        pdfMake.createPdf(docDefinition).open();

        // print the PDF
        // pdfMake.createPdf(docDefinition).print();

        // download the PDF
        //pdfMake.createPdf(docDefinition).download();
    }


    function buildTableBody(data, columns) {
        var body = [];

        body.push(columns);

        data.forEach(function (row) {
            var dataRow = [];

            columns.forEach(function (column) {
                dataRow.push(row[column].toString());
            })

            body.push(dataRow);
        });

        return body;
    }


    function table(data, columns) {
        return {
            table: {
                headerRows: 1,
                body: buildTableBody(data, columns)
            }
        };
    }

</script>

</body>
</html>
